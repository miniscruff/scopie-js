{
  "version": 3,
  "sources": ["../src/scopie.js"],
  "sourcesContent": ["/**\n * Authorization engine for configuring per user per feature access control.\n * Access is configured via plain text and handled directly via code.\n * Configuration storage is controlled by you, scopie just handles the logic.\n *\n * See {@link https://scopie.dev Scopie Docs} for full specification.\n */\n\n\n/** arraySeparator is the character between array elements.\n * See {@link https://scopie.dev/specification/terms/#block block term} for how blocks are formatted.\n */\nexport const arraySeparator = '|';\n\n/** blockSeparator is the character between blocks.\n * See {@link https://scopie.dev/specification/terms/#block block term} for how blocks are formatted.\n */\nexport const blockSeparator = '/';\n\n/** wildcard is the character that matches any value in a block.\n * See {@link https://scopie.dev/specification/terms/#block block term} for how blocks are formatted.\n */\nexport const wildcard = '*';\n\n/** varPrefix is the character that prefixes variables in blocks.\n * See {@link https://scopie.dev/specification/terms/#block block term} for how blocks are formatted.\n */\nexport const varPrefix = '@';\n\n/** allowGrant is the value used to denote an allowed permission.\n * See {@link https://scopie.dev/specification/terms/#grant permission term} for how actions are checked.\n */\nexport const allowGrant = \"allow\";\n\n/** denyGrant is the value used to denote a denied permission.\n * See {@link https://scopie.dev/specification/terms/#grant permission term} for how actions are checked.\n */\nexport const denyGrant = \"deny\";\n\n/** Checks character validity\n * @param {character} char - Single character to check\n * @returns {boolean} whether or not the character is valid within a literal block.\n * @access private\n */\nfunction isValidLiteral(char) {\n  if (char >= 'a' && char <= 'z') {\n    return true;\n  }\n\n  if (char >= 'A' && char <= 'Z') {\n    return true;\n  }\n\n  if (char >= '0' && char <= '9') {\n    return true;\n  }\n\n  return char === '_' || char === '-';\n}\n\n/** Checks character validity\n * @param {character} char - Single character to check\n * @returns {boolean} whether or not the character is valid within a block.\n * @access private\n */\nfunction isValidCharacter(char) {\n  return isValidLiteral(char) || char === varPrefix || char === wildcard;\n}\n\n/** Calculates the end of an array element\n * @param {string} value - Value of our action we are traversing\n * @param {number} start - Index to start searching from\n * @returns {number} index at the end of the array element\n * @access private\n */\nfunction endOfArrayElement(value, start) {\n  for (let i = start + 1; i < value.length; i += 1) {\n    if (value[i] === blockSeparator || value[i] === arraySeparator) {\n      return i;\n    }\n  }\n\n  return value.length;\n}\n\nfunction skipGrant(value) {\n\tif (value.startsWith(denyGrant)) {\n\t\treturn 5\n\t}\n\n\tif (value.startsWith(allowGrant)) {\n\t\treturn 6\n\t}\n\n\tthrow new Error(\"scopie-107: permission does not start with a grant\")\n}\n\n/** Calculates the end of a action block\n * @param {string} category - Value to use when returning an error for our category\n * @param {string} value - Value of our action we are traversing\n * @param {number} start - Index to start searching from\n * @returns {number} index at the end of the action block\n * @access private\n */\nfunction endOfBlock(category, value, start) {\n  for (let i = start; i < value.length; i += 1) {\n    if (value[i] === blockSeparator) {\n      return i;\n    } if (value[i] === arraySeparator) {\n      continue;\n    } else if (!isValidCharacter(value[i])) {\n      throw new Error(`scopie-100 in ${category}: invalid character '${value[i]}'`);\n    }\n  }\n\n  return value.length;\n}\n\n/** Compares two strings with respect to variables and wildcards.\n * @param {string} permission\n * @param {int} permissionLeft\n * @param {int} permissionSlider\n * @param {string} action\n * @param {int} actionLeft\n * @param {int} actionSlider\n * @param {Map<string,string>} vars\n * @returns {boolean} Whether or not our permission block matches the action block\n * @access private\n */\nfunction compareBlock(permission, permissionLeft, permissionSlider, action, actionLeft, actionSlider, vars) {\n  if (permission[permissionLeft] === varPrefix) {\n    const key = permission.substring(permissionLeft + 1, permissionSlider);\n    if (!vars.has(key)) {\n      throw new Error(`scopie-104: variable '${key}' not found`);\n    }\n\n    const varValue = vars.get(key);\n    return varValue === action.substring(actionLeft, actionSlider);\n  }\n\n  if (permissionSlider - permissionLeft === 1 && permission[permissionLeft] === wildcard) {\n    return true;\n  }\n\n  if (permission.substring(permissionLeft, permissionSlider).indexOf(arraySeparator) >= 0) {\n    for (; permissionLeft < permissionSlider;) {\n      const arrayRight = endOfArrayElement(permission, permissionLeft);\n\n      if (permission[permissionLeft] === varPrefix) {\n        throw new Error(`scopie-101: variable '${permission.substring(permissionLeft + 1, arrayRight)}' found in array block`);\n      }\n\n      if (permission[permissionLeft] === wildcard) {\n        if (arrayRight - permissionLeft > 1 && permission[permissionLeft + 1] === wildcard) {\n          throw new Error('scopie-103: super wildcard found in array block');\n        }\n\n        throw new Error('scopie-102: wildcard found in array block');\n      }\n\n      if (permission.substring(permissionLeft, arrayRight) === action.substring(actionLeft, actionSlider)) {\n        return true;\n      }\n\n      permissionLeft = arrayRight + 1;\n    }\n\n    return false;\n  }\n\n  return permission.substring(permissionLeft, permissionSlider) === action.substring(actionLeft, actionSlider);\n}\n\n/** Determines if an permission matches a action\n * @param {string} action\n * @param {string} permission\n * @param {Map<string,string>} vars - Variables for translations\n * @returns {boolean} Whether or not the action matches the permission\n * @access private\n */\nfunction compareActionToPermission(action, permission, vars) {\n  // Skip the grant prefix for permissions\n  let permissionLeft = skipGrant(permission);\n  let actionLeft = 0;\n  let permissionSlider = 0;\n  let actionSlider = 0;\n\n  for (; permissionLeft < permission.length || actionLeft < action.length;) {\n    // In case one is longer then the other\n    if ((permissionLeft < permission.length) !== (actionLeft < action.length)) {\n      return false;\n    }\n\n    actionSlider = endOfBlock('action', action, actionLeft);\n    permissionSlider = endOfBlock('permission', permission, permissionLeft);\n\n    // Super wildcards are checked here as it skips the who rest of the checks.\n    if (\n      permissionSlider - permissionLeft === 2\n      && permission[permissionLeft] === wildcard\n      && permission[permissionLeft + 1] === wildcard\n    ) {\n      if (permission.length > permissionSlider) {\n        throw new Error('scopie-105: super wildcard not in the last block');\n      }\n\n      return true;\n    }\n    if (!compareBlock(\n      permission,\n      permissionLeft,\n      permissionSlider,\n      action,\n      actionLeft,\n      actionSlider,\n      vars,\n    )) {\n      return false;\n    }\n\n    actionLeft = actionSlider + 1;\n    permissionLeft = permissionSlider + 1;\n  }\n\n  return true;\n}\n\n/**\n * Is Allowed determines whether or not the actions are allowed with the given permissions.\n * @param {string[]} actions - actions specifies one or more actions our user must match. When using more then one action, they are treated as a series of OR conditions, and an user will be allowed if they match any of the actions.\n * @param {string[]} permissions - permissions specifies one or more permissions our requesting actions has to have to be allowed access.\n * @param {object} vars - An optional dictionary or map of variable to values. Variable keys should not start with `@`\n * @returns boolean - Whether or not the actions are allowed with the given permissions.\n * @throws Any invalid action or permission issues, see {@link https://scopie.dev/specification/errors/ scopie errors} for possible issues.\n * @example\n * // returns true\n * isAllowed(\n *   [\"accounts/thor/edit\"],         // actions\n *   [\"allow:accounts/@username/*\"], // permissions\n *   { \"username\": \"thor\" },         // vars\n * )\n */\nexport function isAllowed(actions, permissions, vars) {\n  if (permissions.length === 0) {\n    return false;\n  }\n\n  if (actions.length === 0) {\n    throw new Error('scopie-106 in action: actions was empty');\n  }\n\n  let varMap;\n  if (vars) {\n    varMap = new Map(Object.entries(vars));\n  }\n\n  let hasBeenAllowed = false;\n\n  for (let permissionIndex = 0; permissionIndex < permissions.length; permissionIndex += 1) {\n    const permission = permissions[permissionIndex];\n    if (permission.length === 0) {\n      throw new Error('scopie-106 in permission: permission was empty');\n    }\n\n    const isAllowBlock = permission[0] === 'a';\n    if (isAllowBlock && hasBeenAllowed) {\n      continue;\n    }\n\n    for (let actionIndex = 0; actionIndex < actions.length; actionIndex += 1) {\n      const action = actions[actionIndex];\n      if (action.length === 0) {\n        throw new Error('scopie-106 in action: action was empty');\n      }\n\n      const match = compareActionToPermission(action, permission, varMap);\n      if (match && isAllowBlock) {\n        hasBeenAllowed = true;\n      } else if (match && !isAllowBlock) {\n        return false;\n      }\n    }\n  }\n\n  return hasBeenAllowed;\n}\n\n/**\n * Determines whether or not the actions are valid according to scopie specifications.\n * @param {string[]} actions - action or permissions to check\n * @returns {Error|undefined} If the action are invalid, the validation error is returned,\n * otherwise undefined is returned.\n * @example\n * // returns undefined\n * validateActions([\"accounts/thor/edit\"])\n */\nexport function validateActions(actions) {\n  if (actions.length === 0) {\n    return new Error('scopie-106: action array was empty');\n  }\n\n  for (let action of actions) {\n    if (action.length === 0) {\n      return new Error('scopie-106: action was empty');\n    }\n\n    for (let i = 0; i < action.length; i += 1) {\n      if (!isValidLiteral(action[i]) && action[i] !== blockSeparator) {\n        return new Error(`scopie-100: invalid character '${action[i]}'`);\n      }\n    }\n  }\n\n  return undefined;\n}\n\n/**\n * Determines whether or not the permissions are valid according to scopie specifications.\n * @param {string[]} permissions - permissions to check\n * @returns {Error|undefined} If the permissions are invalid, the validation error is returned,\n * otherwise undefined is returned.\n * @example\n * // returns undefined\n * validatePermissions([\"grant:accounts/thor/*\"])\n */\nexport function validatePermissions(permissions) {\n  if (permissions.length === 0) {\n    return new Error('scopie-106: permission array was empty');\n  }\n\n  for (let permission of permissions) {\n    if (permission.length === 0) {\n      return new Error('scopie-106: permission was empty');\n    }\n\n    let inArray = false;\n    let i = 0;\n\n    try {\n      i = skipGrant(permission)\n    } catch(e) {\n      return e\n    }\n\n    for (; i < permission.length; i += 1) {\n      if (permission[i] === blockSeparator) {\n        inArray = false;\n        continue;\n      }\n\n      if (permission[i] === arraySeparator) {\n        inArray = true;\n        continue;\n      }\n\n      if (inArray) {\n        if (permission[i] === wildcard && i < permission.length - 1 && permission[i + 1] === wildcard) {\n          return new Error('scopie-103: super wildcard found in array block');\n        }\n\n        if (permission[i] === wildcard) {\n          return new Error('scopie-102: wildcard found in array block');\n        }\n\n        if (permission[i] === varPrefix) {\n          const end = endOfArrayElement(permission, i);\n          return new Error(`scopie-101: variable '${permission.substring(i + 1, end)}' found in array block`);\n        }\n      }\n\n      if (!isValidCharacter(permission[i])) {\n        return new Error(`scopie-100: invalid character '${permission[i]}'`);\n      }\n\n      if (permission[i] === wildcard && i < permission.length - 1 && permission[i + 1] === wildcard\n        && i < permission.length - 2) {\n        return new Error('scopie-105: super wildcard not in the last block');\n      }\n    }\n  }\n\n  return undefined;\n}\n"],
  "mappings": "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",
  "names": ["isValidLiteral", "char", "isValidCharacter", "endOfArrayElement", "value", "start", "i", "skipGrant", "endOfBlock", "category", "compareBlock", "permission", "permissionLeft", "permissionSlider", "action", "actionLeft", "actionSlider", "vars", "key", "arrayRight", "compareActionToPermission", "actions", "permissions", "varMap", "hasBeenAllowed", "permissionIndex", "isAllowBlock", "actionIndex", "match", "inArray", "e", "end"]
}
