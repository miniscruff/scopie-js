var d=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var $=(r,t)=>{for(var e in t)d(r,e,{get:t[e],enumerable:!0})},B=(r,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of m(t))!A.call(r,i)&&i!==e&&d(r,i,{get:()=>t[i],enumerable:!(o=x(t,i))||o.enumerable});return r};var W=r=>B(d({},"__esModule",{value:!0}),r);var z={};$(z,{allowPermission:()=>g,arraySeperator:()=>p,blockSeperator:()=>w,denyPermission:()=>y,isAllowed:()=>M,validateScopes:()=>j,varPrefix:()=>u,wildcard:()=>l});module.exports=W(z);var p="|",w="/",l="*",u="@",g="allow",y="deny";function b(r){return r>="a"&&r<="z"||r>="A"&&r<="Z"||r>="0"&&r<="9"?!0:r==="_"||r==="-"||r===u||r===l}function k(r,t){for(let e=t+1;e<r.length;e+=1)if(r[e]===w||r[e]===p)return e;return r.length}function h(r,t,e){for(let o=e;o<t.length;o+=1){if(t[o]===w)return o;if(t[o]!==p&&!b(t[o]))throw new Error(`scopie-100 in ${r}: invalid character '${t[o]}'`)}return t.length}function P(r,t,e,o,i,n,f){let s=t;if(r[s]===u){let c=r.substring(s+1,e);if(!f.has(c))throw new Error(`scopie-104: variable '${c}' not found`);return f.get(c)===o.substring(i,n)}if(e-s===1&&r[s]===l)return!0;if(r.substring(s,e).indexOf(p)>=0){for(;s<e;){let c=k(r,s);if(r[s]===u)throw new Error(`scopie-101: variable '${r.substring(s+1,c)}' found in array block`);if(r[s]===l)throw c-s>1&&r[s+1]===l?new Error("scopie-103: super wildcard found in array block"):new Error("scopie-102: wildcard found in array block");if(r.substring(s,c)===o.substring(i,n))return!0;s=c+1}return!1}return r.substring(t,e)===o.substring(i,n)}function I(r,t,e){let o=h("actor",r,0)+1,i=0,n=0,f=0;for(;o<r.length||i<t.length;){if(o<r.length!=i<t.length)return!1;if(n=h("action",t,i),f=h("actor",r,o),f-o===2&&r[o]===l&&r[o+1]===l){if(r.length>f)throw new Error("scopie-105: super wildcard not in the last block");return!0}if(!P(r,o,f,t,i,n,e))return!1;i=n+1,o=f+1}return!0}function M(r,t,e){if(t.length===0)return!1;if(r.length===0)throw new Error("scopie-106 in action: scopes was empty");let o;e&&(o=new Map(Object.entries(e)));let i=!1;for(let n=0;n<t.length;n+=1){let f=t[n];if(f.length===0)throw new Error("scopie-106 in actor: rule was empty");let s=f[0]==="a";if(!(s&&i))for(let c=0;c<r.length;c+=1){let a=r[c];if(a.length===0)throw new Error("scopie-106 in action: scope was empty");let E=I(f,a,o);if(E&&s)i=!0;else if(E&&!s)return!1}}return i}function j(r){if(r.length===0)return new Error("scopie-106: scopes are empty");let t=r[0].startsWith(g)||r[0].startsWith(y);for(let e of r){if(e.length===0)return new Error("scopie-106: scope or rule was empty");let o=e.startsWith(g)||e.startsWith(y);if(t!=o)return new Error("scopie-107: inconsistent array of scopes and rules");let i=!1;for(let n=0;n<e.length;n+=1){if(e[n]===w){i=!1;continue}if(e[n]===p){i=!0;continue}if(i){if(e[n]===l&&n<e.length-1&&e[n+1]===l)return new Error("scopie-103: super wildcard found in array block");if(e[n]===l)return new Error("scopie-102: wildcard found in array block");if(e[n]===u){let f=k(e,n);return new Error(`scopie-101: variable '${e.substring(n+1,f)}' found in array block`)}}if(!b(e[n]))return new Error(`scopie-100: invalid character '${e[n]}'`);if(e[n]===l&&n<e.length-1&&e[n+1]===l&&n<e.length-2)return new Error("scopie-105: super wildcard not in the last block")}}}0&&(module.exports={allowPermission,arraySeperator,blockSeperator,denyPermission,isAllowed,validateScopes,varPrefix,wildcard});
